name: Build iOS (Release - Unsigned)

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  build-ios:
    name: Build iOS IPA (Release - Unsigned)
    runs-on: macos-15
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Show Xcode version
        run: |
          echo "Current Xcode version:"
          xcodebuild -version

      - name: Clean and install dependencies
        run: |
          rm -rf node_modules
          rm -f package-lock.json
          npm install --legacy-peer-deps
          if [ -d "node_modules/react-native-reanimated" ]; then
            rm -rf node_modules/react-native-reanimated
          fi

      - name: Prebuild iOS native project
        run: npx expo prebuild --platform ios --clean

      - name: Patch Podfile for lottie-react-native Xcode 16 compatibility
        run: |
          cd ios
          echo "Patching Podfile for lottie-react-native..."
          
          # Create the lottie fix as a separate file
          cat > /tmp/lottie_fix.rb << 'EOF'
          # Fix lottie-react-native Swift compilation for Xcode 16
          installer.pods_project.targets.each do |target|
            if target.name == "lottie-react-native" || target.name == "lottie-ios"
              target.build_configurations.each do |config|
                config.build_settings["SWIFT_VERSION"] = "5.0"
                config.build_settings["CLANG_ENABLE_MODULES"] = "YES"
                config.build_settings["BUILD_LIBRARY_FOR_DISTRIBUTION"] = "NO"
              end
            end
          end
          EOF
          
          # Check if post_install block exists and inject the fix
          if grep -q "post_install do |installer|" Podfile; then
            echo "Found existing post_install block"
            # Use sed to inject before the closing 'end' of post_install
            # Find line number of post_install, then find its closing end
            LOTTIE_CODE=$(cat /tmp/lottie_fix.rb)
            
            # Create a Python script to do the injection properly
            python3 << 'PYTHON_SCRIPT'
          import re
          
          with open('Podfile', 'r') as f:
              content = f.read()
          
          lottie_fix = '''
            # Fix lottie-react-native Swift compilation for Xcode 16
            installer.pods_project.targets.each do |target|
              if target.name == "lottie-react-native" || target.name == "lottie-ios"
                target.build_configurations.each do |config|
                  config.build_settings["SWIFT_VERSION"] = "5.0"
                  config.build_settings["CLANG_ENABLE_MODULES"] = "YES"
                  config.build_settings["BUILD_LIBRARY_FOR_DISTRIBUTION"] = "NO"
                end
              end
            end
          '''
          
          # Find post_install block and inject before its end
          pattern = r'(post_install do \|installer\|.*?)(^end)'
          
          def replacer(match):
              return match.group(1) + lottie_fix + '\n' + match.group(2)
          
          new_content = re.sub(pattern, replacer, content, flags=re.MULTILINE | re.DOTALL)
          
          with open('Podfile', 'w') as f:
              f.write(new_content)
          
          print("Lottie fix injected into existing post_install block")
          PYTHON_SCRIPT
          else
            echo "Adding new post_install block..."
            echo '' >> Podfile
            echo 'post_install do |installer|' >> Podfile
            echo '  installer.pods_project.targets.each do |target|' >> Podfile
            echo '    if target.name == "lottie-react-native" || target.name == "lottie-ios"' >> Podfile
            echo '      target.build_configurations.each do |config|' >> Podfile
            echo '        config.build_settings["SWIFT_VERSION"] = "5.0"' >> Podfile
            echo '        config.build_settings["CLANG_ENABLE_MODULES"] = "YES"' >> Podfile
            echo '        config.build_settings["BUILD_LIBRARY_FOR_DISTRIBUTION"] = "NO"' >> Podfile
            echo '      end' >> Podfile
            echo '    end' >> Podfile
            echo '  end' >> Podfile
            echo 'end' >> Podfile
          fi
          
          echo "Podfile patched. Last 30 lines:"
          tail -30 Podfile

      - name: Clean CocoaPods caches
        run: |
          cd ios
          pod cache clean --all || true
          rm -rf Pods Podfile.lock || true

      - name: Install CocoaPods dependencies
        run: |
          cd ios
          pod install --repo-update

      - name: Build iOS app (Unsigned)
        run: |
          cd ios
          set -o pipefail
          xcodebuild clean -workspace Rootwise.xcworkspace -scheme Rootwise || true
          xcodebuild -workspace Rootwise.xcworkspace \
            -scheme Rootwise \
            -configuration Release \
            -sdk iphoneos \
            -destination 'generic/platform=iOS' \
            -derivedDataPath build/DerivedData \
            -archivePath $PWD/build/rootwise.xcarchive \
            archive \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            GCC_TREAT_WARNINGS_AS_ERRORS=NO \
            SWIFT_TREAT_WARNINGS_AS_ERRORS=NO \
            2>&1 | tee ../ios-build.log

      - name: Create IPA (unsigned)
        run: |
          cd ios
          mkdir -p Payload
          cp -r build/rootwise.xcarchive/Products/Applications/Rootwise.app Payload/
          zip -r Rootwise.ipa Payload
          rm -rf Payload

      - name: Upload IPA
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: rootwise-unsigned-ipa
          path: ios/Rootwise.ipa
          retention-days: 30

      - name: Upload iOS Build Log on Failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: ios-build-log
          path: ios-build.log
          if-no-files-found: ignore
          retention-days: 7

      - name: Build Complete
        run: echo "Unsigned iOS IPA ready for download"
