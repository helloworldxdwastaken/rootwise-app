name: Build iOS (Release - Unsigned)

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  build-ios:
    name: Build iOS IPA (Release - Unsigned)
    runs-on: macos-15
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Show Xcode version
        run: |
          echo "Current Xcode version:"
          xcodebuild -version
          echo ""
          echo "Available Xcode versions:"
          ls /Applications | grep Xcode || true

      - name: Clean and install dependencies
        run: |
          rm -rf node_modules
          rm -f package-lock.json
          npm install --legacy-peer-deps
          
          # Remove react-native-reanimated if it was pulled in as a transitive dependency
          if [ -d "node_modules/react-native-reanimated" ]; then
            echo "‚ö†Ô∏è Found react-native-reanimated as transitive dependency - removing it"
            rm -rf node_modules/react-native-reanimated
          fi

      - name: Prebuild iOS native project
        run: npx expo prebuild --platform ios --clean

      - name: Patch Podfile for lottie-react-native Xcode 16 compatibility
        run: |
          cd ios
          echo "üìù Adding post_install hooks for lottie-react-native Xcode 16 compatibility..."
          
          # Create a Ruby script to properly patch the Podfile
          cat > patch_podfile.rb << 'RUBY_SCRIPT'
          podfile_path = 'Podfile'
          content = File.read(podfile_path)
          
          # The lottie fix code to inject
          lottie_fix = <<-FIX
          
            # Fix lottie-react-native Swift compilation for Xcode 16
            installer.pods_project.targets.each do |target|
              if target.name == 'lottie-react-native' || target.name == 'lottie-ios'
                target.build_configurations.each do |config|
                  config.build_settings['SWIFT_VERSION'] = '5.0'
                  config.build_settings['CLANG_ENABLE_MODULES'] = 'YES'
                  config.build_settings['BUILD_LIBRARY_FOR_DISTRIBUTION'] = 'NO'
                  config.build_settings['SWIFT_COMPILATION_MODE'] = 'wholemodule'
                end
              end
            end
          FIX
          
          # Find the post_install block and inject before the closing 'end'
          if content.include?('post_install do |installer|')
            # Find the last 'end' of the post_install block by looking for pattern
            # We need to inject our code inside the existing post_install block
            
            # Strategy: Find 'post_install do |installer|' and then find the matching 'end'
            # Inject our code right before that end
            
            lines = content.lines
            post_install_start = nil
            post_install_end = nil
            indent_level = 0
            
            lines.each_with_index do |line, index|
              if line =~ /post_install\s+do\s*\|installer\|/
                post_install_start = index
                indent_level = 1
              elsif post_install_start && indent_level > 0
                indent_level += line.scan(/\bdo\b/).count
                indent_level -= line.scan(/\bend\b/).count
                if indent_level == 0
                  post_install_end = index
                  break
                end
              end
            end
            
            if post_install_start && post_install_end
              # Insert our fix just before the closing end
              lines.insert(post_install_end, lottie_fix)
              content = lines.join
              puts "‚úÖ Injected lottie fix into existing post_install block"
            else
              puts "‚ö†Ô∏è Could not find post_install block boundaries"
            end
          else
            # No post_install block exists, add one at the end
            content += <<-BLOCK

post_install do |installer|
#{lottie_fix}
end
            BLOCK
            puts "‚úÖ Added new post_install block with lottie fix"
          end
          
          File.write(podfile_path, content)
          puts "‚úÖ Podfile patched successfully"
          RUBY_SCRIPT
          
          ruby patch_podfile.rb
          rm patch_podfile.rb
          
          echo ""
          echo "üìÑ Podfile post_install section:"
          grep -A 50 "post_install" Podfile | head -60 || echo "No post_install found"

      - name: Clean CocoaPods caches
        run: |
          cd ios
          pod cache clean --all || true
          rm -rf ~/Library/Caches/CocoaPods || true
          rm -rf ~/Library/Developer/Xcode/DerivedData/* || true
          rm -rf Pods || true
          rm -rf Podfile.lock || true

      - name: Install CocoaPods dependencies
        run: |
          cd ios
          pod install --repo-update

      - name: Verify lottie Swift settings applied
        run: |
          cd ios
          echo "üîç Checking if lottie-react-native has SWIFT_VERSION set..."
          if [ -f "Pods/Pods.xcodeproj/project.pbxproj" ]; then
            grep -A 5 "lottie-react-native" Pods/Pods.xcodeproj/project.pbxproj | grep -i "SWIFT" | head -10 || echo "Swift settings not found in project file directly"
          fi
          echo ""
          echo "‚úÖ Pod install completed, Swift settings should be applied by post_install hooks"

      - name: Build iOS app (Unsigned)
        run: |
          cd ios
          set -o pipefail
          
          xcodebuild clean -workspace Rootwise.xcworkspace -scheme Rootwise || true
          rm -rf ~/Library/Developer/Xcode/DerivedData/ModuleCache.noindex || true
          
          xcodebuild -workspace Rootwise.xcworkspace \
            -scheme Rootwise \
            -configuration Release \
            -sdk iphoneos \
            -destination 'generic/platform=iOS' \
            -derivedDataPath build/DerivedData \
            -archivePath $PWD/build/rootwise.xcarchive \
            archive \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            GCC_TREAT_WARNINGS_AS_ERRORS=NO \
            SWIFT_TREAT_WARNINGS_AS_ERRORS=NO \
            2>&1 | tee ../ios-build.log

      - name: Create IPA (unsigned)
        run: |
          cd ios
          mkdir -p Payload
          cp -r build/rootwise.xcarchive/Products/Applications/Rootwise.app Payload/
          zip -r Rootwise.ipa Payload
          rm -rf Payload

      - name: Upload IPA
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: rootwise-unsigned-ipa
          path: ios/Rootwise.ipa
          retention-days: 30

      - name: Upload iOS Build Log on Failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: ios-build-log
          path: ios-build.log
          if-no-files-found: ignore
          retention-days: 7

      - name: Build Complete
        run: echo "‚úÖ Unsigned iOS IPA ready for download from Artifacts"
